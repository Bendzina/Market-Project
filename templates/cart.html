{% extends 'base.html' %}

{% block content %}
<h2>ğŸ›’ áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ™áƒáƒšáƒáƒ—áƒ˜</h2>

<div id="cart-items">
    {% if cart_items %}
        <ul>
            {% for item in cart_items %}
                <li>
                    <strong>{{ item.product.name }}</strong> -
                    áƒ áƒáƒáƒ“áƒ”áƒœáƒáƒ‘áƒ: {{ item.quantity }} -
                    áƒ¤áƒáƒ¡áƒ˜: {{ item.total_price }}â‚¾
                </li>
            {% endfor %}
        </ul>

        <p><strong>áƒ¡áƒ£áƒš áƒ—áƒáƒœáƒ®áƒ:</strong> {{ total_price }}â‚¾</p>
        <form id="csrf-form">
            {% csrf_token %}
        </form>

        <button id="checkout-btn">áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ</button>
        <p id="checkout-message"></p>
    {% else %}
        <p>áƒ™áƒáƒšáƒáƒ—áƒ˜ áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ.</p>
    {% endif %}
</div>
{% if cart_items %}
  <ul>
    {% for item in cart_items %}
      <li>áƒáƒ áƒáƒ“áƒ£áƒ¥áƒ¢áƒ˜: {{ item.product.name }} - áƒ áƒáƒáƒ“áƒ”áƒœáƒáƒ‘áƒ: {{ item.quantity }} - áƒ¤áƒáƒ¡áƒ˜: {{ item.total_price }}â‚¾</li>
    {% endfor %}
  </ul>
  <p>áƒ¡áƒ£áƒš áƒ—áƒáƒœáƒ®áƒ: {{ total_price }}â‚¾</p>
{% else %}
  <p>áƒ™áƒáƒšáƒáƒ—áƒ˜ áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ.</p>
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const checkoutBtn = document.getElementById("checkout-btn");

        if (checkoutBtn) {
            checkoutBtn.addEventListener("click", async function () {
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                try {
                    const response = await fetch("{% url 'checkout' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrftoken
                        },
                        body: JSON.stringify({})
                    });

                    const data = await response.json();

                    if (response.ok && data.order_id) {
                        document.getElementById("checkout-message").innerText = "âœ… áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ!";
                        setTimeout(() => {
                            window.location.href = `/order/${data.order_id}/`;
                        }, 1500);
                    } else {
                        document.getElementById("checkout-message").innerText = "âŒ " + (data.message || "áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ›áƒáƒ®áƒ“áƒ.");
                    }
                } catch (error) {
                    document.getElementById("checkout-message").innerText = "âŒ áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ—áƒáƒœ áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ.";
                }
            });
        }
    });
</script>

{% endblock %}
